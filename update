#!/bin/bash

. "$(dirname "$0")/libupd"

is_changed() {
  sumcmd=$(which sha256sum sha1sum md5sum cksum | head -1)
  updatebefore="$($sumcmd "$0")"
  libbefore="$($sumcmd "$(dirname "$0")/libupd")"
  pushd "$(dirname "$0")" &>/dev/null
  echo "------ Updating upd ------"
  require git && git pull
  popd &>/dev/null
  updateafter="$($sumcmd "$0")"
  libafter="$($sumcmd "$(dirname "$0")/libupd")"
  [ "$updatebefore" != "$updateafter" -o "$libbefore" != "$libafter" ]
}

update() {
  for ITEM in $(ls "$(dirname "$0")"/enabled/* | sort)
  do
    $ITEM --update
  done
}

echo
echo ================== Starting $(whoami)@$(hostname) ================== 
if ! [ "$1" = "-m" -o "$1" = "--modified" ] && is_changed
then
  echo "Restarting $0"
  "$0" -m
else
  update
  echo ================== Finished $(whoami)@$(hostname) ================== 
fi
