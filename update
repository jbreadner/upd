#!/bin/bash

. "$(dirname "$0")/libupd"

is_changed() {
  sumcmd=$(which sha256sum sha1sum md5sum cksum | head -1)
  beforesum="$($sumcmd "$0")"
  pushd "$(dirname "$0")" &>/dev/null
  echo "------ Updating upd ------"
  require git && git pull
  popd &>/dev/null
  aftersum="$($sumcmd "$0")"

  [ "$beforesum" != "$aftersum" ]
}

update() {
  for ITEM in $(ls "$(dirname "$0")"/enabled/* | sort)
  do
    $ITEM --update
  done
}

echo
echo ================== Starting $(whoami)@$(hostname) ================== 
if is_changed && ! [ "$1" = "-m" -o "$1" = "--modified" ]
then
  echo ------------------ Restarting $(whoami)@$(hostname) ------------------ 
  "$0" -m
  exit
else
  update
fi
echo ================== Finished $(whoami)@$(hostname) ================== 
